<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Running a Local AI to Interact with Your Vault :: Terminal</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="From: Ollama Installation. To: AI Integration Inspired once more by NetworkChuck, this guide walks you through setting up Ollama on your system, integrating various AI models, and enhancing your workflow with ==Stable Diffusion== and ==BMO== or ==Smart Connections== on obsidian. Whether you&rsquo;re a developer or an AI enthusiast, this step-by-step tutorial will help you harness the power of local AI models effectively.
If you also enjoy configuring your AI environment and exploring different models, this approach will provide you with the control and flexibility you need!
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="//localhost:1313/posts/running-a-local-ai-to-interact-with-your-vault/" />





  
  <link rel="stylesheet" href="//localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/code.min.4f0ccc8439f99bf7f7970298556b94011aabc1fcae743b6842fc3361a2da9ea3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/main.min.15870410d15d02abd22fb5ef00996f65a00d04b3a7435e9f83831c7c2298de88.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="//localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Running a Local AI to Interact with Your Vault">
<meta property="og:description" content="From: Ollama Installation. To: AI Integration Inspired once more by NetworkChuck, this guide walks you through setting up Ollama on your system, integrating various AI models, and enhancing your workflow with ==Stable Diffusion== and ==BMO== or ==Smart Connections== on obsidian. Whether you&rsquo;re a developer or an AI enthusiast, this step-by-step tutorial will help you harness the power of local AI models effectively.
If you also enjoy configuring your AI environment and exploring different models, this approach will provide you with the control and flexibility you need!
" />
<meta property="og:url" content="//localhost:1313/posts/running-a-local-ai-to-interact-with-your-vault/" />
<meta property="og:site_name" content="Terminal" />

  <meta property="og:image" content="//localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="tutorials" />


  <meta property="article:published_time" content="2023-12-20 00:00:00 &#43;0000 UTC" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
        
          <li><a href="/showcase" >Showcase</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/running-a-local-ai-to-interact-with-your-vault/">Running a Local AI to Interact with Your Vault</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-12-20</time></div>

  
    <span class="post-tags">
      
      #<a href="//localhost:1313/tags/how_to/">how_to</a>&nbsp;
      
      #<a href="//localhost:1313/tags/obsidian/">obsidian</a>&nbsp;
      
      #<a href="//localhost:1313/tags/ai/">AI</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="from-ollama-installation-to-ai-integration">From: Ollama Installation. To: AI Integration<a href="#from-ollama-installation-to-ai-integration" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Inspired once more by <a href="https://www.youtube.com/watch?v=Wjrdr0NU4Sk">NetworkChuck</a>, this guide walks you through setting up Ollama on your system, integrating various AI models, and enhancing your workflow with ==Stable Diffusion== and ==BMO== or ==Smart Connections== on obsidian. Whether you&rsquo;re a developer or an AI enthusiast, this step-by-step tutorial will help you harness the power of local AI models effectively.</p>
<p>If you also enjoy configuring your AI environment and exploring different models, this approach will provide you with the control and flexibility you need!</p>
<p>What’s happening here is that you’re setting up a local AI server using Ollama, complemented by a web UI for easier interaction and additional tools like Stable Diffusion for image generation. Once everything is configured, maintaining and expanding your AI capabilities requires minimal effort.</p>
<p>Below, I’ll show you how to set up Ollama, integrate various AI models, and enhance your setup with additional tools. You can follow these steps to create your personalized AI environment.</p>
<h2 id="did-you-ever-run-an-ollama">Did you ever run an Ollama?<a href="#did-you-ever-run-an-ollama" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>![[ollama.png|logo]]
<a href="https://github.com/ollama/ollama/tree/main/docs">Ollama</a> is a lightweight, extensible framework for building and running language models on the local machine. It provides a simple API for creating, running, and managing models, as well as a library of pre-built models that can be easily used in a variety of applications.</p>
<p>To get started right away, do the following:</p>
<ol>
<li>
<p><strong>Visit Ollama&rsquo;s Website</strong></p>
<ul>
<li>Go to <a href="https://ollama.com/">ollama.com</a>.</li>
</ul>
</li>
<li>
<p><strong>Install WSL on Windows</strong></p>
<ul>
<li>Open the Windows Command Prompt (CMD) and execute:
<pre tabindex="0"><code>wsl --install
</code></pre></li>
<li>If is the first time, create some auth there.</li>
</ul>
</li>
<li>
<p><strong>Upgrade and Update Packages</strong></p>
<ul>
<li>In your WSL terminal, run:
<pre tabindex="0"><code>sudo apt update
sudo apt upgrade -y
</code></pre></li>
</ul>
</li>
<li>
<p><strong>Download the Linux Version</strong></p>
<ul>
<li>Copy and run the following command from ollama in your terminal:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -fsSL https://ollama.com/install.sh <span class="p">|</span> sh
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Verify Ollama is Running</strong></p>
<ul>
<li>Open your web browser and navigate to:
<pre tabindex="0"><code>localhost:11434
</code></pre></li>
<li>You should see a message indicating that Ollama is running!</li>
<li><em>Note: I think &ldquo;11434&rdquo; can be transleted as &ldquo;llama&rdquo; if you to bend 90º you neek. Once you to figure it out, maybe it won&rsquo;t come back&hellip;</em></li>
</ul>
</li>
<li>
<p><strong>Take care of you llamas</strong></p>
<ul>
<li>To view all the AI models currently installed in your Ollama setup, use the following command:
<pre tabindex="0"><code>ollama list
</code></pre></li>
<li>If you don&rsquo;t what one of those anymore, you can always eliminate whit:
<pre tabindex="0"><code>ollama rm model_name
</code></pre></li>
</ul>
</li>
<li>
<p><strong>Add an AI Model to Ollama</strong></p>
<ul>
<li>Pull the Llama2 model:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ollama pull model_name
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Run and Test the Model</strong></p>
<ul>
<li>
<p>Execute the following command to test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ollama run model_name
</span></span></code></pre></div></li>
<li>
<p>You can interact with the model here. Press <code>Ctrl+C</code> to stop the response and type <code>/bye</code> to close the session.</p>
</li>
</ul>
</li>
</ol>
<h2 id="local-ollama">Local ollama<a href="#local-ollama" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>This is the easy way. Only by installing ollama,it have already star a server, that wait for run ou API calls!
The standard port is 11434, so you can just test some requests. Like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Função para extrair apenas o JSON da resposta</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extrair_json</span><span class="p">(</span><span class="n">response_text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;```json\s*(\{.*?\})\s*```&#39;</span><span class="p">,</span> <span class="n">response_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="k">match</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">json_str</span> <span class="o">=</span> <span class="k">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:11434/api/generate&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;application/json&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;model&#34;</span><span class="p">:</span> <span class="s2">&#34;tinyllama&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;system&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;&#34;Como o bot agira e exemplos&#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;prompt&#34;</span><span class="p">:</span> <span class="s2">&#34;A pergunta que deseja saber&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;stream&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;num_predict&#34;</span><span class="p">:</span> <span class="mi">160</span><span class="p">,</span>     <span class="c1"># Quantidade máxima de resposta</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;top_p&#34;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>           <span class="c1"># Reduzir variabilidade</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;top_k&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>              <span class="c1"># Forçar escolhas mais determinísticas</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;repeat_penalty&#34;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>   <span class="c1"># Evita penalidades</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;seed&#34;</span><span class="p">:</span> <span class="mi">42</span>              <span class="c1"># Mantém consistência nas respostas</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">texto_resposta</span> <span class="o">=</span> <span class="n">response_data</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">resposta_dict</span> <span class="o">=</span> <span class="n">extrair_json</span><span class="p">(</span><span class="n">texto_resposta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;created_at: &#39;</span><span class="p">,</span> <span class="n">response_data</span><span class="p">[</span> <span class="s1">&#39;created_at&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;model: &#39;</span><span class="p">,</span> <span class="n">response_data</span><span class="p">[</span> <span class="s1">&#39;model&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;response: &#39;</span><span class="p">,</span> <span class="n">resposta_dict</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="web-ui">Web UI<a href="#web-ui" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>The <a href="https://github.com/open-webui/open-webui">Web UI</a> provides an entire interface to interact with your AI models more conveniently. There are several options available, and for this guide, we&rsquo;ll set up <strong>Open Web UI</strong> using Docker.</p>
<h3 id="installing-docker">Installing Docker<a href="#installing-docker" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<ol>
<li>
<p><strong>Add Docker&rsquo;s Official GPG Key and Repository</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get update
</span></span><span class="line"><span class="cl">sudo apt-get install ca-certificates curl
</span></span><span class="line"><span class="cl">sudo install -m <span class="m">0755</span> -d /etc/apt/keyrings
</span></span><span class="line"><span class="cl">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
</span></span><span class="line"><span class="cl">sudo chmod a+r /etc/apt/keyrings/docker.asc
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">&#34;deb [arch=</span><span class="k">$(</span>dpkg --print-architecture<span class="k">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="k">$(</span>. /etc/os-release <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$VERSION_CODENAME</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2"> stable&#34;</span> <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span class="line"><span class="cl">sudo apt-get update
</span></span></code></pre></div></li>
<li>
<p><strong>Install Docker</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</span></span></code></pre></div></li>
</ol>
<h3 id="running-the-web-ui-container">Running the Web UI Container<a href="#running-the-web-ui-container" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<ol>
<li><strong>Start the Container</strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo docker run -d --network<span class="o">=</span>host -v open-webui:/app/backend/data -e <span class="nv">OLLAMA_BASE_URL</span><span class="o">=</span>http://127.0.0.1:11434 --name open-webui --restart always ghcr.io/open-webui/open-webui:main
</span></span></code></pre></div><ul>
<li>If you need to stop it:</li>
</ul>
<pre tabindex="0"><code>sudo docker stop open-webui
sudo docker rm open-webui
sudo docker stop $(sudo docker ps -q)
</code></pre></li>
<li><strong>Verify the Container is Running</strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo docker ps
</span></span></code></pre></div><ul>
<li>You should see a list of running containers, indicating that the Web UI is available at:
<pre tabindex="0"><code>http://localhost:8080/auth
</code></pre></li>
<li>Create a local access credential. The first login uses the <code>admin</code> account.</li>
<li>Connection settings can be found under <code>Settings</code> -&gt; <code>Connections</code>.</li>
</ul>
</li>
</ol>
<h2 id="adding-more-models">Adding More Models<a href="#adding-more-models" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<ol>
<li><strong>Pull Additional Models via Ollama</strong>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ollama pull codegen
</span></span></code></pre></div><ul>
<li>After installation, the model will be available in the Web UI&rsquo;s selection box.</li>
</ul>
</li>
</ol>
<h2 id="managing-access">Managing Access<a href="#managing-access" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>You can manage user access through the admin panel:</p>
<ol>
<li><strong>Access the Admin Panel</strong>
<ul>
<li>Click on the bottom-left logo and navigate to the admin section.</li>
</ul>
</li>
<li><strong>Manage Users and Groups</strong>
<ul>
<li>In the <code>Users</code> section, create and assign users to specific groups to control access permissions.</li>
</ul>
</li>
</ol>
<h2 id="creating-custom-models">Creating Custom Models<a href="#creating-custom-models" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>To create your own models:</p>
<ol>
<li><strong>Access the Workspace</strong>
<ul>
<li>Navigate to the workspace and click the <code>+</code> button on the top-right corner to add a new model.</li>
</ul>
</li>
</ol>
<h2 id="using-ai-into-the-vault">Using AI into the Vault<a href="#using-ai-into-the-vault" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="adding-ai-to-smart-connections">Adding AI to Smart Connections<a href="#adding-ai-to-smart-connections" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<ol>
<li><strong>Configure Local AI in Chat Settings</strong>
<ul>
<li>Select the <code>Local</code> option and choose the desired model name from the chat configuration settings.</li>
</ul>
</li>
</ol>
<h3 id="bmo-option">BMO option<a href="#bmo-option" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Installing the BMO plugin will enable the default chosen model. The available commands are:</p>
<h4 id="general-commands">General Commands<a href="#general-commands" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<ul>
<li><code>/clear</code> or <code>/c</code> - Clear chat history.</li>
<li><code>/ref on</code> - Turn on &ldquo;reference current note&rdquo;.</li>
<li><code>/ref off</code> - Turn off &ldquo;reference current note&rdquo;.</li>
<li><code>/maxtokens [VALUE]</code> - Set max tokens.</li>
<li><code>/temp [VALUE]</code> - Change temperature range from 0 to 2.</li>
</ul>
<h4 id="profile-commands">Profile Commands<a href="#profile-commands" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<ul>
<li><code>/profile</code> - List profiles.</li>
<li><code>/profile [PROFILE-NAME] or [VALUE]</code> - Change profile.</li>
</ul>
<h4 id="model-commands">Model Commands<a href="#model-commands" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<ul>
<li><code>/model</code> - List models.</li>
<li><code>/model [MODEL-NAME] or [VALUE]</code> - Change model.</li>
</ul>
<h4 id="prompt-commands">Prompt Commands<a href="#prompt-commands" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<ul>
<li><code>/prompt</code> - List prompts.</li>
<li><code>/prompt [PROMPT-NAME] or [VALUE]</code> - Change prompts.</li>
<li><code>/prompt clear</code> - Clear prompt.</li>
</ul>
<h4 id="editor-commands">Editor Commands<a href="#editor-commands" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<ul>
<li><code>/append</code> - Append current chat history to the current active note.</li>
<li><code>/save</code> - Save current chat history to a note.</li>
<li><code>/load</code> - List or load a chat history into view.</li>
</ul>
<h4 id="response-commands">Response Commands<a href="#response-commands" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<ul>
<li><code>/stop</code> or <code>/s</code> - Stop fetching response. <strong>Warning:</strong> Anthropic models cannot be aborted. Use with caution.</li>
</ul>
<h3 id="call-queries-from-python-scripter">Call queries from Python Scripter<a href="#call-queries-from-python-scripter" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>If you like to play some hard code, you can to try to run the script direct from the control painel, or even from the cmd. Since none of those solutions worked for me, this is what i build:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">##ObsidianAssistant
</span></span></span><span class="line"><span class="cl"><span class="s2">Solução para chamar a API ollama usando apenas dados sobre as notas do Obsidian em prompt tunning. Lê a nota mais recente no diretório self_questions, devove em estrutura de pastas por date time em self_talk ou em self_graphs.
</span></span></span><span class="line"><span class="cl"><span class="s2">- Aguarda uma estrutura de diretórios a serem lidos: base_path = self.vault_path / &#34;Notas&#34; / &#34;Tratados&#34;.
</span></span></span><span class="line"><span class="cl"><span class="s2">- Aguarda possuir o Tinyllama instalado como modelo padrão. Pode alterar isso no YAML da própria nota.
</span></span></span><span class="line"><span class="cl"><span class="s2">- Escreva resuma|explique|desenhe|encontre|relacione e cite o contexto como faria normalmente na nota usando [[]]. 
</span></span></span><span class="line"><span class="cl"><span class="s2">- Chame o script pelo scripter ou cmd usando o seguinte pip: pip install requests datetime pathlib pyyaml fuzzywuzzy networkx matplotlib numpy pyvis pandas python-Levenshtein community.
</span></span></span><span class="line"><span class="cl"><span class="s2">- Abra o grafico no navegador e os dados salvos em seu visualizador de .xlsx.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">### Armazenamento
</span></span></span><span class="line"><span class="cl"><span class="s2">- Grafos: self_graphs/YYYY/MM/DD/
</span></span></span><span class="line"><span class="cl"><span class="s2">- Conversas: self_talks/YYYY/MM/DD/
</span></span></span><span class="line"><span class="cl"><span class="s2">- Cache: Pickle para armazenamento temporário
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">### Configuração
</span></span></span><span class="line"><span class="cl"><span class="s2">Via arquivo YAML em self_questions/:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">### Desempenho:
</span></span></span><span class="line"><span class="cl"><span class="s2">5 a 6 seg em 16GB RAM, sem GPU para modelo tinyllama.
</span></span></span><span class="line"><span class="cl"><span class="s2">2 a 3 minutos em 16GB RAM, sem GPU para modelo llama2
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">### Recursos:
</span></span></span><span class="line"><span class="cl"><span class="s2">1. /resuma [elemento]
</span></span></span><span class="line"><span class="cl"><span class="s2">- Gera resumos de notas ou diretórios
</span></span></span><span class="line"><span class="cl"><span class="s2">- Exemplo: /resuma nota.md
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">2. /explique [elemento]
</span></span></span><span class="line"><span class="cl"><span class="s2">- Fornece explicações detalhadas
</span></span></span><span class="line"><span class="cl"><span class="s2">- Exemplo: /explique #conceito
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">3. /desenhe [elemento]
</span></span></span><span class="line"><span class="cl"><span class="s2">- Cria visualizações em grafo usando pyvis
</span></span></span><span class="line"><span class="cl"><span class="s2">- Exemplo: /desenhe diretório Notas
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">4. /encontre [termo]
</span></span></span><span class="line"><span class="cl"><span class="s2">- Realiza buscas no vault
</span></span></span><span class="line"><span class="cl"><span class="s2">- Exemplo: /encontre python
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">5. /relacione [elemento1], [elemento2]
</span></span></span><span class="line"><span class="cl"><span class="s2">- Analisa relações entre elementos
</span></span></span><span class="line"><span class="cl"><span class="s2">- Exemplo: /relacione #tag1, #tag2
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">yaml</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">SafeLoader</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pickle</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">community</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pyvis.network</span> <span class="kn">import</span> <span class="n">Network</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">traceback</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ObsidianAssistant</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Inicializando ObsidianAssistant...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">vault_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Vault path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Registrar handlers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;/desenhe&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_visualization</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;/explique&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_explain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;/resuma&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_summary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;/encontre&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_find</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;/relacione&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_relationships</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Comandos registrados: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">identify_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Identifica comandos com / e sem /&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Identificando comando em: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">words</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">words</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Prompt vazio&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prompt</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="n">first_word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">remaining</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Verificar comando desenhe especificamente</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">first_word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;desenhe&#39;</span><span class="p">,</span> <span class="s1">&#39;/desenhe&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Comando desenhe identificado&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;/desenhe&#34;</span><span class="p">,</span> <span class="n">remaining</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="c1"># Outros comandos</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">first_word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Comando </span><span class="si">{</span><span class="n">first_word</span><span class="si">}</span><span class="s2"> identificado&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">first_word</span><span class="p">,</span> <span class="n">remaining</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Nenhum comando identificado&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prompt</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">prompt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Adicionar strip()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Verificar explicitamente se é o comando desenhe</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;desenhe&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/desenhe&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Iniciando geração do grafo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Remover o comando do prompt</span>
</span></span><span class="line"><span class="cl">                <span class="n">remaining</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;desenhe&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;/desenhe&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Chamar diretamente o handler de visualização</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_visualization</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Identificação normal de outros comandos</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_command</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">!=</span> <span class="s2">&#34;/desenhe&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">remaining</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">save_to_md</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="c1"># Fallback para consulta normal</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_md</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar comando: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>  <span class="c1"># Adicionar para debug</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Única função nova realmente necessária&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_context</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Explique detalhadamente este conteúdo:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Forneça:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Conceitos principais
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Exemplos práticos
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Relações importantes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao explicar: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Handler para /explique&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_context</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Explique detalhadamente este conteúdo:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Forneça:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Conceitos principais
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Exemplos práticos
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Relações importantes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao explicar: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Limpar o prompt</span>
</span></span><span class="line"><span class="cl">            <span class="n">clean_prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;/resuma&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Remover [[ e ]] se existirem</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">clean_prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;[[&#34;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">clean_prompt</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;]]&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">clean_prompt</span> <span class="o">=</span> <span class="n">clean_prompt</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Verificar se é diretório</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_directory</span> <span class="o">=</span> <span class="s2">&#34;diretório&#34;</span> <span class="ow">in</span> <span class="n">clean_prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&#34;diretorio&#34;</span> <span class="ow">in</span> <span class="n">clean_prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">is_directory</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">target_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;/resuma&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;diretório&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;diretorio&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;o&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Converter para Path e resolver caminho</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Caminho completo: </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Se é caminho absoluto, tentar tornar relativo ao vault</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Caminho relativo ao vault: </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Usando caminho absoluto&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Caminho completo para busca</span>
</span></span><span class="line"><span class="cl">                    <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">dir_path</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Buscando em: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Diretório não encontrado: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Coletar conteúdo de todos os arquivos .md</span>
</span></span><span class="line"><span class="cl">                    <span class="n">all_content</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">file_names</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">md_file</span> <span class="ow">in</span> <span class="n">full_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">md_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">end_pos</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="n">end_pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">end_pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                <span class="n">all_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="n">file_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Arquivo processado: </span><span class="si">{</span><span class="n">md_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler </span><span class="si">{</span><span class="n">md_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Nenhum arquivo markdown encontrado em: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Juntar conteúdo com referências</span>
</span></span><span class="line"><span class="cl">                    <span class="n">combined_content</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_content</span><span class="p">,</span> <span class="n">file_names</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">combined_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">=== Arquivo: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ===</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Criar prompt para resumo</span>
</span></span><span class="line"><span class="cl">                    <span class="n">summary_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Por favor, faça um resumo abrangente do seguinte conteúdo de um diretório com </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_content</span><span class="p">)</span><span class="si">}</span><span class="s2"> arquivos markdown:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    </span><span class="si">{</span><span class="n">combined_content</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Por favor, forneça um resumo estruturado que inclua:
</span></span></span><span class="line"><span class="cl"><span class="s2">    1. Principais tópicos abordados
</span></span></span><span class="line"><span class="cl"><span class="s2">    2. Conceitos-chave
</span></span></span><span class="line"><span class="cl"><span class="s2">    3. Pontos importantes
</span></span></span><span class="line"><span class="cl"><span class="s2">    4. Relações entre os diferentes arquivos&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Gerando resumo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">summary_prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Resumo do diretório: </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Total de arquivos processados: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_content</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Arquivos incluídos: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar diretório: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao processar diretório: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Se não tiver context_notes, usar o prompt limpo</span>
</span></span><span class="line"><span class="cl">                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_notes&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">clean_prompt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Processando arquivo: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_context</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Nenhum conteúdo encontrado para: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">summary_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Por favor, faça um resumo estruturado do seguinte texto:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Por favor, inclua:
</span></span></span><span class="line"><span class="cl"><span class="s2">    1. Principais pontos
</span></span></span><span class="line"><span class="cl"><span class="s2">    2. Conceitos-chave
</span></span></span><span class="line"><span class="cl"><span class="s2">    3. Conclusões importantes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Gerando resumo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">summary_prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar arquivo: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao resumir arquivo: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro no handle_summary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao gerar resumo: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Busca elementos relacionados ao tema&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Buscar em notas</span>
</span></span><span class="line"><span class="cl">            <span class="n">note_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzy_find_note</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">note</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">note_matches</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;📄 Nota: </span><span class="si">{</span><span class="n">note</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> (relevância: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">%)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Buscar em tags</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#(\w+)&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tag_notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_notes_by_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tag_notes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;🏷️ Tag: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Buscar em diretórios</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">dir_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;📁 Diretório: </span><span class="si">{</span><span class="n">dir_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_search_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro na busca: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Analisa relações entre elementos&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;Por favor, forneça dois ou mais elementos para relacionar.&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">contents</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notes_from_path</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">notes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">content</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Analise as relações entre os seguintes elementos:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Elementos: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Conteúdos:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Manter funcionalidade de visualização da versão antiga</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;visualize&#34;</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_knowledge_graph</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">visualize_knowledge_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s2">&#34;Grafo de Relações&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao relacionar: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">format_search_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Formata os resultados da busca&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;Nenhum resultado encontrado.&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="c1"># Formatar resposta</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;# Resultados da Busca</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;Termo pesquisado: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;## Resultados encontrados:</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Adicionar sugestões de próximos passos</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">## Próximos passos sugeridos:&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;- Use /explique para ver detalhes de uma nota específica&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;- Use /relacione para ver conexões entre elementos&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;- Use /desenhe para visualizar as relações em grafo&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_content_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Obtém o conteúdo de um arquivo markdown&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Converter para Path se for string</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar extensão .md se não existir</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="c1"># Se é caminho absoluto, tentar tornar relativo ao vault</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="c1"># Caminho completo para o arquivo</span>
</span></span><span class="line"><span class="cl">            <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">file_path</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Tentando ler arquivo: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Se não encontrar diretamente, tentar buscar por nome</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Arquivo não encontrado diretamente, buscando por nome...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Buscar em todo o vault</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">found_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">found_file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">file_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">full_path</span> <span class="o">=</span> <span class="n">found_file</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Arquivo encontrado em: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Arquivo não encontrado: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Lendo arquivo: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="c1"># Remover YAML frontmatter se existir</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">end_pos</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">end_pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">end_pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler arquivo: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">visualize_knowledge_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;Grafo de Conhecimento&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Visualiza o grafo de conhecimento em HTML interativo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Criar diretório self_graphs se não existir</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="s2">&#34;self_graphs&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">html_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&#34;graph_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.html&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&#34;graph_data_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.json&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Criar visualização</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">height</span><span class="o">=</span><span class="s2">&#34;750px&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">width</span><span class="o">=</span><span class="s2">&#34;100%&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&#34;#ffffff&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">font_color</span><span class="o">=</span><span class="s2">&#34;black&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">select_menu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">filter_menu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">cdn_resources</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span>  <span class="c1"># Usar CDN remoto</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Configurar cabeçalho HTML personalizado</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;!DOCTYPE html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;!-- Vis.js CDN --&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;link rel=&#34;stylesheet&#34; href=&#34;https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css&#34; integrity=&#34;sha512-WgxfT5LWjfszlPHXRmBWHkV2eceiWTOBvrKCNbdgDYTHrT2AeLCGbF4sZlZw3UMN3WtL0tGUoIAKsu8mllg/XA==&#34; crossorigin=&#34;anonymous&#34; referrerpolicy=&#34;no-referrer&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;script src=&#34;https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js&#34; integrity=&#34;sha512-LnvoEWDFrqGHlHmDD2101OrLcbsfkrzoSpvtSQtxK3RMnRV0eOkhhBN2dXHKRrUU8p2DGRTk35n4O8nWSVe1mQ==&#34; crossorigin=&#34;anonymous&#34; referrerpolicy=&#34;no-referrer&#34;&gt;&lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;!-- Bootstrap CDN --&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;link href=&#34;https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css&#34; rel=&#34;stylesheet&#34; integrity=&#34;sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6&#34; crossorigin=&#34;anonymous&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;script src=&#34;https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js&#34; integrity=&#34;sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf&#34; crossorigin=&#34;anonymous&#34;&gt;&lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;!-- Tom Select CDN --&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;link href=&#34;https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css&#34; rel=&#34;stylesheet&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;script src=&#34;https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;style type=&#34;text/css&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    #mynetwork {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        width: 100%;
</span></span></span><span class="line"><span class="cl"><span class="s2">                        height: 750px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                        background-color: #ffffff;
</span></span></span><span class="line"><span class="cl"><span class="s2">                        border: 1px solid lightgray;
</span></span></span><span class="line"><span class="cl"><span class="s2">                        position: relative;
</span></span></span><span class="line"><span class="cl"><span class="s2">                        float: left;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    }
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;/head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;div class=&#34;container-fluid&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;div id=&#34;mynetwork&#34;&gt;&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;script type=&#34;text/javascript&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">net</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            {
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;nodes&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;font&#34;: {&#34;size&#34;: 16, &#34;strokeWidth&#34;: 2},
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;borderWidth&#34;: 2,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;shadow&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;scaling&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;min&#34;: 20,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;max&#34;: 60
</span></span></span><span class="line"><span class="cl"><span class="s2">                    }
</span></span></span><span class="line"><span class="cl"><span class="s2">                },
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;edges&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;color&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;inherit&#34;: false,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;color&#34;: &#34;#666666&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;opacity&#34;: 0.8
</span></span></span><span class="line"><span class="cl"><span class="s2">                    },
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;smooth&#34;: {&#34;type&#34;: &#34;continuous&#34;},
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;length&#34;: 200,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;width&#34;: 1.5
</span></span></span><span class="line"><span class="cl"><span class="s2">                },
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;physics&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;barnesHut&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;gravitationalConstant&#34;: -2000,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;centralGravity&#34;: 0.3,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;springLength&#34;: 200,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;springConstant&#34;: 0.04,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;damping&#34;: 0.09
</span></span></span><span class="line"><span class="cl"><span class="s2">                    },
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;solver&#34;: &#34;barnesHut&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;stabilization&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;enabled&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;iterations&#34;: 1000,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;updateInterval&#34;: 25
</span></span></span><span class="line"><span class="cl"><span class="s2">                    }
</span></span></span><span class="line"><span class="cl"><span class="s2">                },
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;interaction&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;hover&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;tooltipDelay&#34;: 200,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;zoomView&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;dragView&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;navigationButtons&#34;: true
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar nós e arestas aqui</span>
</span></span><span class="line"><span class="cl">            <span class="n">nodes_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="n">edges_data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar nós ao Network</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">node_data</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">node_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Usar apenas o nome do arquivo como label</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">net</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">title</span><span class="o">=</span><span class="n">node_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">color</span><span class="o">=</span><span class="n">node_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;#4287f5&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size</span><span class="o">=</span><span class="n">node_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">label</span><span class="o">=</span><span class="n">node_label</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">physics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Guardar dados do nó para JSON</span>
</span></span><span class="line"><span class="cl">                <span class="n">nodes_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">node_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">node_label</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;full_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar arestas com propriedades específicas</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">net</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">str</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
</span></span><span class="line"><span class="cl">                    <span class="nb">str</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">physics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">smooth</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;continuous&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#666666&#39;</span><span class="p">,</span> <span class="s1">&#39;opacity&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Guardar dados da aresta para JSON</span>
</span></span><span class="line"><span class="cl">                <span class="n">edges_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar código de fechamento do HTML</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span><span class="o">.</span><span class="n">html</span> <span class="o">+=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    // Inicializar o grafo
</span></span></span><span class="line"><span class="cl"><span class="s2">                    var network = new vis.Network(container, data, options);
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;/body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &lt;/html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Salvar HTML</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">html_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">html</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Salvar dados do grafo</span>
</span></span><span class="line"><span class="cl">            <span class="n">graph_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="n">nodes_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="n">edges_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;total_nodes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;total_edges&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;directory&#39;</span><span class="p">:</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;Estrutura do Diretório: &#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">graph_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Salvar visualização</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Salvando visualização em: </span><span class="si">{</span><span class="n">html_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Salvando dados do grafo em: </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">html_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro na visualização: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Cria um esquema estruturado ou grafo de diretório&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Debug handle_outline:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Prompt recebido: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Config: </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;diretório&#34;</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Extrair o nome do diretório do prompt</span>
</span></span><span class="line"><span class="cl">                <span class="n">parts</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;diretório&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Pegar a última parte após &#34;diretório&#34; e limpar</span>
</span></span><span class="line"><span class="cl">                    <span class="n">directory</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Remover palavras comuns que podem aparecer no prompt</span>
</span></span><span class="line"><span class="cl">                    <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;como é o&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;do&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;da&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">directory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_notes&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretório encontrado: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="s2">&#34;Erro: Especifique um diretório no prompt ou em context_notes&#34;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Construindo grafo...&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">                <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_directory_graph</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Grafo construído com </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s2"> nós e </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2"> arestas&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Visualizando grafo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">visualize_knowledge_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Estrutura do Diretório: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Grafo da estrutura do diretório &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; gerado com sucesso!&#34;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro detalhado ao gerar grafo: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao gerar grafo do diretório: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Se não for visualização de diretório, criar esquema normal</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Crie um esquema estruturado sobre o tema, com:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Tópicos principais
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Subtópicos
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Pontos-chave
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Conexões entre conceitos
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tema: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">build_directory_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Constrói um grafo representando a estrutura de diretórios&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">directory_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretório não encontrado: </span><span class="si">{</span><span class="n">directory_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">add_directory_to_graph</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;directory&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.md&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">add_directory_to_graph</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">add_directory_to_graph</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">G</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">generate_graph_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Gera relatório básico do grafo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;# Relatório do Grafo
</span></span></span><span class="line"><span class="cl"><span class="s2">    Data: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Carrega o cache de resumos&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao carregar cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">save_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Salva o cache de resumos&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao salvar cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_latest_config_from_vault</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Busca a configuração mais recente na pasta self_questions
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            Dict com configurações encontradas no YAML mais recente
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">config_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="s2">&#34;self_questions&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">latest_file</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">latest_time</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">config_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_time</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">file_time</span> <span class="o">&gt;</span> <span class="n">latest_time</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">latest_time</span> <span class="o">=</span> <span class="n">file_time</span>
</span></span><span class="line"><span class="cl">                    <span class="n">latest_file</span> <span class="o">=</span> <span class="n">file</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">latest_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Nenhum arquivo de configuração encontrado em self_questions/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latest_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Arquivo </span><span class="si">{</span><span class="n">latest_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> não contém metadados YAML&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="n">yaml_end</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">yaml_content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">yaml_end</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">prompt</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">yaml_end</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Campos obrigatórios faltando: </span><span class="si">{</span><span class="n">missing_fields</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="n">final_config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;tinyllama&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;context_notes&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_notes&#39;</span><span class="p">,</span> <span class="p">[]),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[]),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;prompt&#39;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;max_tokens&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_tokens&#39;</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;previous_context&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_context&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="n">latest_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;hora&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hora&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">final_config</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler configuração: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_notes_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_note</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Obtém notas de um caminho ou nome de nota específico
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">            path_or_note: Caminho da pasta ou nome da nota
</span></span></span><span class="line"><span class="cl"><span class="s2">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            Lista de tuplas (caminho, conteúdo)
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">path_or_note</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Se é um caminho de diretório</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">path_or_note</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">path_or_note</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">base_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Busca recursivamente todos os arquivos .md no diretório</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">base_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Tenta encontrar arquivo específico</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">base_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">base_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">),</span> <span class="n">content</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler </span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Busca fuzzy por nome de nota</span>
</span></span><span class="line"><span class="cl">            <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzy_find_note</span><span class="p">(</span><span class="n">path_or_note</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_path</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">notes</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_validate_portuguese_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Valida se a resposta está em português e corrige se necessário.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">spanish_indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="s1">&#39;la&#39;</span><span class="p">,</span> <span class="s1">&#39;el&#39;</span><span class="p">,</span> <span class="s1">&#39;los&#39;</span><span class="p">,</span> <span class="s1">&#39;las&#39;</span><span class="p">,</span> <span class="s1">&#39;una&#39;</span><span class="p">,</span> <span class="s1">&#39;pero&#39;</span><span class="p">,</span> <span class="s1">&#39;como&#39;</span><span class="p">,</span> <span class="s1">&#39;está&#39;</span><span class="p">,</span> <span class="s1">&#39;esta&#39;</span><span class="p">,</span> <span class="s1">&#39;muy&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_response</span> <span class="o">=</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_attempts</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">words</span> <span class="o">=</span> <span class="n">current_response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">spanish_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">spanish_indicators</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">spanish_count</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">current_response</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Detectada resposta em espanhol. Tentativa </span><span class="si">{</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Preparar nova requisição diretamente para a API</span>
</span></span><span class="line"><span class="cl">            <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:11434/api/generate&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;ATENÇÃO: Reescreva em português brasileiro (pt-BR):
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">current_response</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            IMPORTANTE: 
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Use APENAS português brasileiro
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Mantenha o mesmo conteúdo e estrutura
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Preserve termos técnicos
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. NÃO use espanhol&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;model&#34;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;prompt&#34;</span><span class="p">:</span> <span class="n">new_prompt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;system&#34;</span><span class="p">:</span> <span class="s2">&#34;IMPORTANTE: Responda APENAS em português brasileiro (pt-BR).&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;stream&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;num_predict&#34;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;stop&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Spanish:&#34;</span><span class="p">,</span> <span class="s2">&#34;Español:&#34;</span><span class="p">,</span> <span class="s2">&#34;En español:&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">new_response</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_lines</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">json_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">new_response</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;response&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;done&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span>
</span></span><span class="line"><span class="cl">                        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">current_response</span> <span class="o">=</span> <span class="n">new_response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao tentar traduzir: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">current_response</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Limite de tentativas atingido. Retornando última resposta.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">current_response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">query_ollama</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">previous_context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Consulta o modelo Ollama para processar comandos do Obsidian Assistant.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Comandos Suportados:
</span></span></span><span class="line"><span class="cl"><span class="s2">        -------------------
</span></span></span><span class="line"><span class="cl"><span class="s2">        /resuma [elemento]
</span></span></span><span class="line"><span class="cl"><span class="s2">            Gera um resumo conciso do elemento especificado
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Input: Nota ou conteúdo a ser resumido
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Output: Resumo em 3 parágrafos com pontos principais
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Exemplo: /resuma metodologia.md
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        /explique [elemento]
</span></span></span><span class="line"><span class="cl"><span class="s2">            Fornece explicação detalhada do elemento
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Input: Nota, conceito ou termo
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Output: Explicação estruturada com conceitos e exemplos
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Exemplo: /explique #metodologia-agil
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        /desenhe [elemento]
</span></span></span><span class="line"><span class="cl"><span class="s2">            Gera visualização gráfica usando Pyvis
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Input: Diretório, tag ou nota
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Output: Arquivo HTML com grafo interativo
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Exemplo: /desenhe diretório Notas/Projetos
</span></span></span><span class="line"><span class="cl"><span class="s2">            Nota: Usa funções build_directory_graph() e visualize_knowledge_graph()
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        /encontre [termo]
</span></span></span><span class="line"><span class="cl"><span class="s2">            Realiza busca por termo específico
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Input: Termo ou expressão de busca
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Output: Lista ordenada de resultados com contexto
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Exemplo: /encontre metodologia ágil
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        /relacione [elemento1], [elemento2]
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analisa relações entre elementos
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Input: Dois elementos (tags, notas ou diretórios)
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Output: Lista de conexões e suas relevâncias
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Exemplo: /relacione #agile, #scrum
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Contextos:
</span></span></span><span class="line"><span class="cl"><span class="s2">        ---------
</span></span></span><span class="line"><span class="cl"><span class="s2">        context: Optional[str]
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Contexto adicional para enriquecer a consulta
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Pode incluir metadados, tags ou conteúdo relacionado
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Adicionado ao prompt como &#34;Contexto adicional&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        previous_context: str
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Histórico de interações anteriores
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Mantém continuidade na conversa
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Adicionado ao prompt como &#34;Contexto anterior&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">            model (str): Nome do modelo Ollama a ser usado
</span></span></span><span class="line"><span class="cl"><span class="s2">            prompt (str): Comando e parâmetros a serem processados
</span></span></span><span class="line"><span class="cl"><span class="s2">            context (Optional[str]): Contexto adicional para a consulta
</span></span></span><span class="line"><span class="cl"><span class="s2">            previous_context (str): Contexto de interações anteriores
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            str: Resposta processada do modelo ou resultado da visualização
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Exemplos:
</span></span></span><span class="line"><span class="cl"><span class="s2">            &gt;&gt;&gt; query_ollama(&#34;tinyllama&#34;, &#34;/resuma nota.md&#34;, context=&#34;Tag: #projeto&#34;)
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;Resumo estruturado da nota...&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            &gt;&gt;&gt; query_ollama(&#34;tinyllama&#34;, &#34;/desenhe diretório Notas&#34;)
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;Grafo gerado em: self_graphs/graph_20240220_123456.html&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:11434/api/generate&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Processar referências a notas no prompt</span>
</span></span><span class="line"><span class="cl">        <span class="n">note_references</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\[(.*?)\]\]&#39;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">note_contents</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">note_ref</span> <span class="ow">in</span> <span class="n">note_references</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Limpar o nome da nota (remover aliases se houver)</span>
</span></span><span class="line"><span class="cl">                <span class="n">note_name</span> <span class="o">=</span> <span class="n">note_ref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">note_ref</span> <span class="k">else</span> <span class="n">note_ref</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Buscar conteúdo da nota</span>
</span></span><span class="line"><span class="cl">                <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notes_from_path</span><span class="p">(</span><span class="n">note_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">notes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Pegar o conteúdo da primeira nota encontrada</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">note_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Conteúdo da nota </span><span class="si">{</span><span class="n">note_name</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao buscar nota </span><span class="si">{</span><span class="n">note_ref</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">note_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao buscar nota </span><span class="si">{</span><span class="n">note_ref</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Se encontrou conteúdo de notas, adicionar ao contexto</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">note_contents</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">additional_context</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">note_contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">additional_context</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span> <span class="o">=</span> <span class="n">additional_context</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># System prompt mais direto e focado na execução</span>
</span></span><span class="line"><span class="cl">        <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;Você é um assistente especializado em análise de conhecimento do Obsidian.
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Dá respostas ULTRA-CURTAS e diretas
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Usa máximo 2 linhas para explicar
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Se usar código, limita a 1 linha
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Responde em português BR
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Mantém termos técnicos em inglês
</span></span></span><span class="line"><span class="cl"><span class="s2">        - É breve e direto.
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Cita uma explicação curta
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Usa um uso prático e curto do conceito
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Insere um ponto final
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Sua resposta acaba SEMPRE antes do ponto final
</span></span></span><span class="line"><span class="cl"><span class="s2">        - No total teremos apenas uma explicação e um exemplo de uso do conceito
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        IMPORTANTE: Você é sucinto. SEMPRE elabora uma resposta que não atinge o num_predict, pois ela acaba antes disso.
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Exemplo:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - prompt: Como usar list comprehension em Python?
</span></span></span><span class="line"><span class="cl"><span class="s2">        - resposta: List comprehension (ou compreensão de lista) é um operador Python que permite criar uma lista a partir de outra lista ou iterável. A sintaxe básica para list comprehension é:
</span></span></span><span class="line"><span class="cl"><span class="s2">        ```python
</span></span></span><span class="line"><span class="cl"><span class="s2">        x = [i for i in range(10)]
</span></span></span><span class="line"><span class="cl"><span class="s2">        ```
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Adicionar instruções específicas baseadas no comando</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/resuma&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">system_prompt</span> <span class="o">+=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ao receber /resuma:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. SEMPRE responda em português brasileiro
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Se o termo ou conteúdo estiver em outro idioma, não o altere
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Crie um resumo conciso em 3 parágrafos
</span></span></span><span class="line"><span class="cl"><span class="s2">            4 .Mantenha o foco no conteúdo fornecido
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Preserve termos técnicos de programação
</span></span></span><span class="line"><span class="cl"><span class="s2">            6. Finalize antes de atingor o num_predict
</span></span></span><span class="line"><span class="cl"><span class="s2">            7. Não liste comandos ou explique o processo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/explique&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">system_prompt</span> <span class="o">+=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ao receber /explique:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. SEMPRE responda em português brasileiro
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Se o termo ou conteúdo estiver em outro idioma, não o altere
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Forneça uma explicação detalhada dos principais pontos do texto
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Liste os conceitos principais
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Inclua exemplos práticos quando possível
</span></span></span><span class="line"><span class="cl"><span class="s2">            6. Identifique relações importantes
</span></span></span><span class="line"><span class="cl"><span class="s2">            7. Não liste comandos ou explique o processo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/desenhe&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Extrair o alvo da visualização</span>
</span></span><span class="line"><span class="cl">                <span class="n">target</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/desenhe&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;diretório&#34;</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Extrair o nome do diretório do prompt</span>
</span></span><span class="line"><span class="cl">                    <span class="n">parts</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;diretório&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">directory</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Remover palavras comuns que podem aparecer no prompt</span>
</span></span><span class="line"><span class="cl">                    <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;como é o&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;do&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;da&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretório encontrado: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="s2">&#34;Erro: Especifique um diretório no prompt&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Construindo grafo...&#34;</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">                    <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_directory_graph</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Grafo construído com </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s2"> nós e </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span><span class="si">}</span><span class="s2"> arestas&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Visualizando grafo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_knowledge_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Estrutura do Diretório: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Para visualizações baseadas em tags ou outros elementos</span>
</span></span><span class="line"><span class="cl">                    <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_knowledge_graph</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_knowledge_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Visualização: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro detalhado na visualização: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao gerar visualização: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/encontre&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">system_prompt</span> <span class="o">+=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. SEMPRE responda em português brasileiro
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Se o termo ou conteúdo estiver em outro idioma, não o altere
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ao receber /encontre:
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Busque o termo solicitado
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Liste resultados relevantes
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Ordene por relevância
</span></span></span><span class="line"><span class="cl"><span class="s2">            6. Inclua contexto breve para cada resultado
</span></span></span><span class="line"><span class="cl"><span class="s2">            7. Não liste comandos ou explique o processo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/relacione&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">system_prompt</span> <span class="o">+=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ao receber /relacione:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. SEMPRE responda em português brasileiro
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Se o termo ou conteúdo estiver em outro idioma, não o altere
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Analise os elementos fornecidos
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Identifique conexões diretas e indiretas
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Liste as relações encontradas
</span></span></span><span class="line"><span class="cl"><span class="s2">            6. Explique a relevância de cada conexão
</span></span></span><span class="line"><span class="cl"><span class="s2">            7. Não liste comandos ou explique o processo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Incluir contextos no payload</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_prompt</span> <span class="o">=</span> <span class="n">prompt</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">full_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">Contexto adicional:</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">previous_context</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">full_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">Contexto anterior:</span><span class="se">\n</span><span class="si">{</span><span class="n">previous_context</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">num_predict</span> <span class="o">=</span> <span class="mi">2048</span>  <span class="c1"># valor padrão</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;num_predict&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">num_predict</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;num_predict&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;model&#34;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;prompt&#34;</span><span class="p">:</span> <span class="n">full_prompt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;system&#34;</span><span class="p">:</span> <span class="s2">&#34;IMPORTANTE: Responda APENAS em português brasileiro (pt-BR). &#34;</span> <span class="o">+</span> <span class="n">system_prompt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;stream&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;options&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;num_predict&#34;</span><span class="p">:</span> <span class="n">num_predict</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">full_response</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_lines</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">json_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">full_response</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;response&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;done&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_portuguese_response</span><span class="p">(</span><span class="n">full_response</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro na consulta: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro na consulta: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">build_knowledge_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Constrói um grafo de conhecimento baseado nas notas&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Percorre todas as notas markdown</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                <span class="c1"># Adiciona nó para a nota atual</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Procura links para outras notas</span>
</span></span><span class="line"><span class="cl">                <span class="n">links</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\[(.*?)\]\]&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">link</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">G</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">validate_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Valida e corrige a saída do modelo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;Nenhuma resposta gerada.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">common_words</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;o&#34;</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="s2">&#34;é&#34;</span><span class="p">,</span> <span class="s2">&#34;de&#34;</span><span class="p">,</span> <span class="s2">&#34;que&#34;</span><span class="p">,</span> <span class="s2">&#34;e&#34;</span><span class="p">,</span> <span class="s2">&#34;do&#34;</span><span class="p">,</span> <span class="s2">&#34;da&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">common_words</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;Erro: Resposta gerada não está em português.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">corrections</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;fomulário&#34;</span><span class="p">:</span> <span class="s2">&#34;formulário&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;resutados&#34;</span><span class="p">:</span> <span class="s2">&#34;resultados&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;armazeinar&#34;</span><span class="p">:</span> <span class="s2">&#34;armazenar&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">wrong</span><span class="p">,</span> <span class="n">correct</span> <span class="ow">in</span> <span class="n">corrections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">wrong</span><span class="p">,</span> <span class="n">correct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_outline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Cria um esquema estruturado&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Crie um esquema estruturado sobre o tema, com:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Tópicos principais
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Subtópicos
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Pontos-chave
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Conexões entre conceitos
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Tema: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_vault_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Analisa os dados do diretório e retorna um DataFrame estruturado&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Analisando diretório: </span><span class="si">{</span><span class="n">directory_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">directory_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretório não encontrado: </span><span class="si">{</span><span class="n">directory_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;n_tags&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;n_links&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;yaml_data&#39;</span><span class="p">:</span> <span class="p">[]</span>  <span class="c1"># Novo: armazenar metadados YAML</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">def</span> <span class="nf">extract_yaml_and_content</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;&#34;&#34;Extrai YAML frontmatter e conteúdo do arquivo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">yaml_data</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">end_pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">yaml_text</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="n">yaml_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_text</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">end_pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar YAML: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">yaml_data</span><span class="p">,</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">def</span> <span class="nf">extract_tags</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">yaml_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;&#34;&#34;Extrai tags do conteúdo e do YAML&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Tags do conteúdo (formato #tag)</span>
</span></span><span class="line"><span class="cl">                <span class="n">content_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#([\w/-]+)&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Tags do YAML</span>
</span></span><span class="line"><span class="cl">                <span class="n">yaml_tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">in</span> <span class="n">yaml_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">yaml_tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">tag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">yaml_tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">yaml_tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Combinar e limpar tags</span>
</span></span><span class="line"><span class="cl">                <span class="n">all_tags</span> <span class="o">=</span> <span class="n">content_tags</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">yaml_tags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">{</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">all_tags</span> <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">def</span> <span class="nf">extract_links</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;&#34;&#34;Extrai links do conteúdo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Links wiki-style</span>
</span></span><span class="line"><span class="cl">                <span class="n">wiki_links</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\[(.*?)\]\]&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Links markdown</span>
</span></span><span class="line"><span class="cl">                <span class="n">md_links</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[([^\]]+)\]\(([^)]+)\)&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">clean_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Processar wiki-links</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">wiki_links</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">in</span> <span class="n">link</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">link</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">clean_links</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Adicionar links markdown</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">md_links</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span> <span class="s1">&#39;ftp&#39;</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>  <span class="c1"># Ignorar links externos</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clean_links</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">clean_links</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">def</span> <span class="nf">process_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;&#34;&#34;Processa um único arquivo e retorna seus dados&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># Converter caminhos para lowercase para consistência</span>
</span></span><span class="line"><span class="cl">                    <span class="n">relative_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dir_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="c1"># Extrair YAML e conteúdo</span>
</span></span><span class="line"><span class="cl">                    <span class="n">yaml_data</span><span class="p">,</span> <span class="n">clean_content</span> <span class="o">=</span> <span class="n">extract_yaml_and_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Extrair tags e links</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tags</span> <span class="o">=</span> <span class="n">extract_tags</span><span class="p">(</span><span class="n">clean_content</span><span class="p">,</span> <span class="n">yaml_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">links</span> <span class="o">=</span> <span class="n">extract_links</span><span class="p">(</span><span class="n">clean_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># Debug para verificar tags encontradas</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Tags encontradas em </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- Do YAML: </span><span class="si">{</span><span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- Do conteúdo: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#([\w/-]+)&#39;</span><span class="p">,</span> <span class="n">clean_content</span><span class="p">))</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- Tags finais: </span><span class="si">{</span><span class="n">tags</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">relative_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="n">dir_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">links</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;n_tags&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;n_links&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;yaml_data&#39;</span><span class="p">:</span> <span class="n">yaml_data</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Processar cada arquivo no diretório</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">directory_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*.md&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_data</span> <span class="o">=</span> <span class="n">process_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">file_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Criar DataFrame</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Estatísticas finais</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Estatísticas da análise:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Total de arquivos processados: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretórios encontrados: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Total de tags únicas: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">})</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Total de links únicos: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">})</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro na análise dos dados: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">handle_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">=== Iniciando Visualização ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Limpar e processar o caminho do diretório</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_dir</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;o diretório&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_dir</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context_notes&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">target_dir</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;context_notes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_dir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;Erro: Diretório não especificado&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Converter para objeto Path e normalizar</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">target_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Caminho completo: </span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Se o caminho é absoluto, tentar torná-lo relativo ao vault</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">target_path</span> <span class="o">=</span> <span class="n">target_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Caminho relativo ao vault: </span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Usando caminho absoluto&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Verificar se o diretório existe</span>
</span></span><span class="line"><span class="cl">                <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">target_path</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro: Diretório não encontrado: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretório encontrado: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar caminho: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao processar caminho do diretório: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Criar estrutura de pastas organizada por data</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="s2">&#34;self_graphs&#34;</span> <span class="o">/</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y/%m/</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Diretório de saída criado: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Nomes dos arquivos com horário</span>
</span></span><span class="line"><span class="cl">            <span class="n">time_prefix</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%H-%M-%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">html_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&#34;graph_</span><span class="si">{</span><span class="n">time_prefix</span><span class="si">}</span><span class="s2">.html&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">excel_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&#34;data_</span><span class="si">{</span><span class="n">time_prefix</span><span class="si">}</span><span class="s2">.xlsx&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Arquivos a serem gerados:</span><span class="se">\n</span><span class="s2">- Grafo: </span><span class="si">{</span><span class="n">html_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">- Excel: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Analisar diretório</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Analisando diretório...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_vault_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">target_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;Nenhum arquivo encontrado no diretório especificado&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Encontrados </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> arquivos para análise&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Salvar Excel com dados estruturados</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Gerando arquivo Excel...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">excel_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Arquivo&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Caminho&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Diretório&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Links&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Qtd Tags&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_tags&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;Qtd Links&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_links&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">excel_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">excel_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">excel_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">excel_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Dados do Vault&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Excel salvo com sucesso em: </span><span class="si">{</span><span class="n">excel_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao salvar Excel: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Criar grafo com estilo aprimorado</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Criando grafo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_color</span> <span class="o">=</span> <span class="s1">&#39;#4287f5&#39;</span>  <span class="c1"># Azul</span>
</span></span><span class="line"><span class="cl">            <span class="n">tag_color</span> <span class="o">=</span> <span class="s1">&#39;#f54242&#39;</span>   <span class="c1"># Vermelho</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar nós de arquivo</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Adicionando nós de arquivo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">friendly_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Criar caminho absoluto para o arquivo</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Criar URL relativa ao servidor web local</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Usamos caminho absoluto com file:/// para abrir diretamente no navegador</span>
</span></span><span class="line"><span class="cl">                <span class="n">file_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;file:///</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1"># Tooltip com link direto para o arquivo</span>
</span></span><span class="line"><span class="cl">                <span class="n">tooltip</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;&lt;div style=&#39;background-color: white; padding: 10px; border-radius: 5px;&#39;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;b&gt;Arquivo:&lt;/b&gt; </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;b&gt;Caminho:&lt;/b&gt; </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;b&gt;Tags:&lt;/b&gt; </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;b&gt;Links:&lt;/b&gt; </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;div style=&#39;margin-top: 8px;&#39;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &lt;a href=&#39;</span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="s2">&#39; target=&#39;_blank&#39; onclick=&#39;window.open(this.href); return false;&#39;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                            Abrir arquivo
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &lt;/a&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">                &lt;/div&gt;&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">friendly_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">title</span><span class="o">=</span><span class="n">tooltip</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">label</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">color</span><span class="o">=</span><span class="n">file_color</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">searchable</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Configurar visualização com permissão para links externos</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">height</span><span class="o">=</span><span class="s2">&#34;750px&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">width</span><span class="o">=</span><span class="s2">&#34;100%&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&#34;#ffffff&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">font_color</span><span class="o">=</span><span class="s2">&#34;black&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">select_menu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">filter_menu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">cdn_resources</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Adicionar configuração para permitir links externos</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            {
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;nodes&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;font&#34;: {&#34;size&#34;: 16, &#34;strokeWidth&#34;: 2},
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;borderWidth&#34;: 2,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;shadow&#34;: true
</span></span></span><span class="line"><span class="cl"><span class="s2">                },
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;edges&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;color&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;inherit&#34;: false,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;color&#34;: &#34;#666666&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;opacity&#34;: 0.8
</span></span></span><span class="line"><span class="cl"><span class="s2">                    },
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;smooth&#34;: {&#34;type&#34;: &#34;continuous&#34;}
</span></span></span><span class="line"><span class="cl"><span class="s2">                },
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;interaction&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;hover&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;tooltipDelay&#34;: 200,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;hideEdgesOnDrag&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;multiselect&#34;: true
</span></span></span><span class="line"><span class="cl"><span class="s2">                },
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#34;physics&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;barnesHut&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;gravitationalConstant&#34;: -2000,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;centralGravity&#34;: 0.3,
</span></span></span><span class="line"><span class="cl"><span class="s2">                        &#34;springLength&#34;: 200
</span></span></span><span class="line"><span class="cl"><span class="s2">                    },
</span></span></span><span class="line"><span class="cl"><span class="s2">                    &#34;stabilization&#34;: {&#34;iterations&#34;: 50}
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Finalizar e salvar grafo</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Salvando grafo...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span><span class="o">.</span><span class="n">from_nx</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">net</span><span class="o">.</span><span class="n">save_graph</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">html_path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">=== Visualização concluída com sucesso! ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Visualização gerada com sucesso!
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Arquivos gerados:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Grafo: </span><span class="si">{</span><span class="n">html_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Dados: </span><span class="si">{</span><span class="n">excel_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Estatísticas:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Total de arquivos: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Total de tags: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Total de links: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_links&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Diretórios analisados: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">=== ERRO NA VISUALIZAÇÃO ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro detalhado:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro ao gerar grafo: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">process_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">prompt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">command</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_command</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">remaining</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">save_to_md</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao processar prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Erro: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">save_to_md</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Salva a interação em arquivo markdown&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">folder_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span> <span class="o">/</span> <span class="s2">&#34;self_talks&#34;</span> <span class="o">/</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y/%m/</span><span class="si">%d</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H-%M-%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.md&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">folder_name</span> <span class="o">/</span> <span class="n">file_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">folder_name</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;# Consulta: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">## Pergunta:</span><span class="se">\n</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">## Resposta:</span><span class="se">\n</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Arquivo salvo em: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_notes_by_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">content_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Busca notas por tags e conteúdo&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">matching_notes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">yaml_data</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">end_yaml</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">yaml_content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">end_yaml</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                            <span class="n">yaml_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yaml_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">end_yaml</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">                        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">found_tags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#[\w/]+&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">found_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">found_tags</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">found_tags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">found_tags</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">content_filter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">content_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                                <span class="n">matching_notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">matching_notes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Erro ao ler </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">matching_notes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fuzzy_find_note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Busca notas usando correspondência fuzzy&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&#34;*.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">ratio</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">summarize_note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Gera um resumo da nota&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">content_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">content_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cache_time</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">content_hash</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">cache_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_duration</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">summary</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Faça um resumo conciso do seguinte texto, destacando os pontos principais:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Limite o resumo a aproximadamente </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2"> caracteres.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_ollama</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">content_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">summary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">save_cache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">summary</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">vault_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Iniciando assistente com vault em: </span><span class="si">{</span><span class="n">vault_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">assistant</span> <span class="o">=</span> <span class="n">ObsidianAssistant</span><span class="p">(</span><span class="n">vault_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Lê configuração</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">assistant</span><span class="o">.</span><span class="n">get_latest_config_from_vault</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">prompt</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;prompt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Tratar comando desenhe diretamente</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;desenhe&#39;</span><span class="p">,</span> <span class="s1">&#39;/desenhe&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Comando de visualização detectado&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Remover &#39;desenhe&#39; ou &#39;/desenhe&#39; do prompt</span>
</span></span><span class="line"><span class="cl">            <span class="n">clean_prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;desenhe&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/desenhe&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">assistant</span><span class="o">.</span><span class="n">handle_visualization</span><span class="p">(</span><span class="n">clean_prompt</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Processamento concluído!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>  <span class="c1"># Importante: retornar aqui para evitar self_talks</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="c1"># Outros comandos</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">assistant</span><span class="o">.</span><span class="n">process_command</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Processamento concluído!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Erro no processamento principal: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p>This whay i can ask some question, make conection to some ideias an talk whit you data. All by your self. It work fine.In my case better than any plugin.
The last created file on the self_questions folder is anwsered in the self_grahs one. If some graphs are out put, they are stored at self_graphs. Like this one bellow:
![[self_graph.png|logo]]</p>
<h2 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>This guide provides a comprehensive walkthrough for setting up Ollama on your local machine, integrating various AI models, managing user access, and enhancing your setup with tools like Stable Diffusion and BMO. By following these steps, you can create a robust and flexible AI environment tailored to your specific needs.</p>
<h3 id="common-issues">Common Issues<a href="#common-issues" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<ul>
<li><strong>Ollama not running:</strong> Ensure the installation script executed without errors and that WSL is properly installed.</li>
<li><strong>Docker issues:</strong> Verify Docker is installed correctly and that the Docker daemon is running.</li>
<li><strong>Model not appearing in Web UI:</strong> Ensure the model was pulled successfully using <code>ollama pull [model_name]</code>.</li>
<li><strong>Stable Diffusion installation errors:</strong> Check that all prerequisites are installed and that Pyenv is configured correctly.</li>
</ul>
<h3 id="regular-tasks">Regular Tasks<a href="#regular-tasks" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<ul>
<li><strong>Update AI models:</strong> Regularly pull updates for your AI models using Ollama.</li>
<li><strong>Backup configurations:</strong> Keep backups of your Docker configurations and AI models.</li>
<li><strong>Monitor system resources:</strong> Ensure your system can handle the resource demands of running multiple AI models.</li>
</ul>
<h3 id="considerations">Considerations<a href="#considerations" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Setting up a local AI environment provides greater control over your data and models. It allows for customization and integration with various tools, enhancing productivity and enabling advanced functionalities. While the initial setup requires technical knowledge, the long-term benefits make it a worthwhile investment for AI enthusiasts and professionals alike.</p>
<h2 id="references">References<a href="#references" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=Wjrdr0NU4Sk">Host All Your AI Locally</a></li>
</ul>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Read other posts</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="//localhost:1313/posts/an-obsidian-ide-for-python/" class="button inline prev">
        &lt; [<span class="button__text">An Obsidian IDE for Python</span>]
      </a>
    
    
      ::
    
    
      <a href="//localhost:1313/posts/building-a-blog-system-using-obsidian/" class="button inline next">
         [<span class="button__text">Building a Blog System Using Obsidian</span>] &gt;
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
